!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.ActionCable={})}(this,function(t){"use strict";function s(t){if("function"==typeof t&&(t=t()),!t||/^wss?:/i.test(t))return t;var e=document.createElement("a");return e.href=t,e.href=e.href,e.protocol=e.protocol.replace("http","ws"),e.href}function e(t){var e=0<arguments.length&&t!==undefined?arguments[0]:n("url")||o.default_mount_path;return new i(e)}function n(t){var e=document.head.querySelector("meta[name='action-cable-"+t+"']");if(e)return e.getAttribute("content")}var d={logger:self.console,WebSocket:self.WebSocket},g={log:function r(){if(this.enabled){for(var t,e=arguments.length,n=Array(e),o=0;o<e;o++)n[o]=arguments[o];n.push(Date.now()),(t=d.logger).log.apply(t,["[ActionCable]"].concat(n))}}},l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},m=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},c=function(){function o(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(t,e,n){return e&&o(t.prototype,e),n&&o(t,n),t}}(),y=function y(){return(new Date).getTime()},v=function v(t){return(y()-t)/1e3},b=function b(t,e,n){return Math.max(e,Math.min(n,t))},f=function(){function e(t){m(this,e),this.visibilityDidChange=this.visibilityDidChange.bind(this),this.connection=t,this.reconnectAttempts=0}return e.prototype.start=function t(){this.isRunning()||(this.startedAt=y(),delete this.stoppedAt,this.startPolling(),addEventListener("visibilitychange",this.visibilityDidChange),g.log("ConnectionMonitor started. pollInterval = "+this.getPollInterval()+" ms"))},e.prototype.stop=function n(){this.isRunning()&&(this.stoppedAt=y(),this.stopPolling(),removeEventListener("visibilitychange",this.visibilityDidChange),g.log("ConnectionMonitor stopped"))},e.prototype.isRunning=function o(){return this.startedAt&&!this.stoppedAt},e.prototype.recordPing=function i(){this.pingedAt=y()},e.prototype.recordConnect=function r(){this.reconnectAttempts=0,this.recordPing(),delete this.disconnectedAt,g.log("ConnectionMonitor recorded connect")},e.prototype.recordDisconnect=function s(){this.disconnectedAt=y(),g.log("ConnectionMonitor recorded disconnect")},e.prototype.startPolling=function c(){this.stopPolling(),this.poll()},e.prototype.stopPolling=function u(){clearTimeout(this.pollTimeout)},e.prototype.poll=function a(){var t=this;this.pollTimeout=setTimeout(function(){t.reconnectIfStale(),t.poll()},this.getPollInterval())},e.prototype.getPollInterval=function h(){var t=this.constructor.pollInterval,e=t.min,n=t.max,o=t.multiplier*Math.log(this.reconnectAttempts+1);return Math.round(1e3*b(o,e,n))},e.prototype.reconnectIfStale=function l(){this.connectionIsStale()&&(g.log("ConnectionMonitor detected stale connection. reconnectAttempts = "+this.reconnectAttempts+", pollInterval = "+this.getPollInterval()+" ms, time disconnected = "+v(this.disconnectedAt)+" s, stale threshold = "+this.constructor.staleThreshold+" s"),this.reconnectAttempts++,this.disconnectedRecently()?g.log("ConnectionMonitor skipping reopening recent disconnect"):(g.log("ConnectionMonitor reopening"),this.connection.reopen()))},e.prototype.connectionIsStale=function p(){return v(this.pingedAt?this.pingedAt:this.startedAt)>this.constructor.staleThreshold},e.prototype.disconnectedRecently=function d(){return this.disconnectedAt&&v(this.disconnectedAt)<this.constructor.staleThreshold},e.prototype.visibilityDidChange=function f(){var t=this;"visible"===document.visibilityState&&setTimeout(function(){!t.connectionIsStale()&&t.connection.isOpen()||(g.log("ConnectionMonitor reopening stale connection on visibilitychange. visibilityState = "+document.visibilityState),t.connection.reopen())},200)},e}();f.pollInterval={min:3,max:30,multiplier:5},f.staleThreshold=6;var o={message_types:{welcome:"welcome",disconnect:"disconnect",ping:"ping",confirmation:"confirm_subscription",rejection:"reject_subscription"},disconnect_reasons:{unauthorized:"unauthorized",invalid_request:"invalid_request",server_restart:"server_restart"},default_mount_path:"/cable",protocols:["actioncable-v1-json","actioncable-unsupported"]},u=o.message_types,C=o.protocols,A=C.slice(0,C.length-1),S=[].indexOf,a=function(){function e(t){m(this,e),this.open=this.open.bind(this),this.consumer=t,this.subscriptions=this.consumer.subscriptions,this.monitor=new f(this),this.disconnected=!0}return e.prototype.send=function n(t){return!!this.isOpen()&&(this.webSocket.send(JSON.stringify(t)),!0)},e.prototype.open=function t(){return this.isActive()?(g.log("Attempted to open WebSocket, but existing socket is "+this.getState()),!1):(g.log("Opening WebSocket, current state is "+this.getState()+", subprotocols: "+C),this.webSocket&&this.uninstallEventHandlers(),this.webSocket=new d.WebSocket(this.consumer.url,C),this.installEventHandlers(),this.monitor.start(),!0)},e.prototype.close=function o(t){if((0<arguments.length&&t!==undefined?arguments[0]:{allowReconnect:!0}).allowReconnect||this.monitor.stop(),this.isActive())return this.webSocket.close()},e.prototype.reopen=function i(){if(g.log("Reopening WebSocket, current state is "+this.getState()),!this.isActive())return this.open();try{return this.close()}catch(t){g.log("Failed to reopen WebSocket",t)}finally{g.log("Reopening WebSocket in "+this.constructor.reopenDelay+"ms"),setTimeout(this.open,this.constructor.reopenDelay)}},e.prototype.getProtocol=function r(){if(this.webSocket)return this.webSocket.protocol},e.prototype.isOpen=function s(){return this.isState("open")},e.prototype.isActive=function c(){return this.isState("open","connecting")},e.prototype.isProtocolSupported=function u(){return 0<=S.call(A,this.getProtocol())},e.prototype.isState=function a(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];return 0<=S.call(e,this.getState())},e.prototype.getState=function h(){if(this.webSocket)for(var t in d.WebSocket)if(d.WebSocket[t]===this.webSocket.readyState)return t.toLowerCase();return null},e.prototype.installEventHandlers=function l(){for(var t in this.events){var e=this.events[t].bind(this);this.webSocket["on"+t]=e}},e.prototype.uninstallEventHandlers=function p(){for(var t in this.events)this.webSocket["on"+t]=function(){}},e}();a.reopenDelay=500,a.prototype.events={message:function t(e){if(this.isProtocolSupported()){var n=JSON.parse(e.data),o=n.identifier,t=n.message,i=n.reason,r=n.reconnect;switch(n.type){case u.welcome:return this.monitor.recordConnect(),this.subscriptions.reload();case u.disconnect:return g.log("Disconnecting. Reason: "+i),this.close({allowReconnect:r});case u.ping:return this.monitor.recordPing();case u.confirmation:return this.subscriptions.notify(o,"connected");case u.rejection:return this.subscriptions.reject(o);default:return this.subscriptions.notify(o,"received",t)}}},open:function k(){if(g.log("WebSocket onopen event, using '"+this.getProtocol()+"' subprotocol"),this.disconnected=!1,!this.isProtocolSupported())return g.log("Protocol is unsupported. Stopping monitor and disconnecting."),this.close({allowReconnect:!1})},close:function I(){if(g.log("WebSocket onclose event"),!this.disconnected)return this.disconnected=!0,this.monitor.recordDisconnect(),this.subscriptions.notifyAll("disconnected",{willAttemptReconnect:this.monitor.isRunning()})},error:function R(){g.log("WebSocket onerror event")}};var h=function h(t,e){if(null!=e)for(var n in e){var o=e[n];t[n]=o}return t},p=function(){function r(t,e,n){var o=1<arguments.length&&e!==undefined?arguments[1]:{},i=n;m(this,r),this.consumer=t,this.identifier=JSON.stringify(o),h(this,i)}return r.prototype.perform=function o(t,e){var n=1<arguments.length&&e!==undefined?arguments[1]:{};return n.action=t,this.send(n)},r.prototype.send=function e(t){return this.consumer.send({command:"message",identifier:this.identifier,data:JSON.stringify(t)})},r.prototype.unsubscribe=function t(){return this.consumer.subscriptions.remove(this)},r}(),w=function(){function e(t){m(this,e),this.consumer=t,this.subscriptions=[]}return e.prototype.create=function r(t,e){var n=t,o="object"===(void 0===n?"undefined":l(n))?n:{channel:n},i=new p(this.consumer,o,e);return this.add(i)},e.prototype.add=function n(t){return this.subscriptions.push(t),this.consumer.ensureActiveConnection(),this.notify(t,"initialized"),this.sendCommand(t,"subscribe"),t},e.prototype.remove=function o(t){return this.forget(t),this.findAll(t.identifier).length||this.sendCommand(t,"unsubscribe"),t},e.prototype.reject=function i(t){var e=this;return this.findAll(t).map(function(t){return e.forget(t),e.notify(t,"rejected"),t})},e.prototype.forget=function t(e){return this.subscriptions=this.subscriptions.filter(function(t){return t!==e}),e},e.prototype.findAll=function s(e){return this.subscriptions.filter(function(t){return t.identifier===e})},e.prototype.reload=function c(){var e=this;return this.subscriptions.map(function(t){return e.sendCommand(t,"subscribe")})},e.prototype.notifyAll=function u(e){for(var n=this,t=arguments.length,o=Array(1<t?t-1:0),i=1;i<t;i++)o[i-1]=arguments[i];return this.subscriptions.map(function(t){return n.notify.apply(n,[t,e].concat(o))})},e.prototype.notify=function a(t,e){for(var n=arguments.length,o=Array(2<n?n-2:0),i=2;i<n;i++)o[i-2]=arguments[i];return("string"==typeof t?this.findAll(t):[t]).map(function(t){return"function"==typeof t[e]?t[e].apply(t,o):undefined})},e.prototype.sendCommand=function h(t,e){var n=t.identifier;return this.consumer.send({command:e,identifier:n})},e}(),i=function(){function e(t){m(this,e),this._url=t,this.subscriptions=new w(this),this.connection=new a(this)}return e.prototype.send=function n(t){return this.connection.send(t)},e.prototype.connect=function t(){return this.connection.open()},e.prototype.disconnect=function o(){return this.connection.close({allowReconnect:!1})},e.prototype.ensureActiveConnection=function i(){if(!this.connection.isActive())return this.connection.open()},c(e,[{key:"url",get:function r(){return s(this._url)}}]),e}();t.Connection=a,t.ConnectionMonitor=f,t.Consumer=i,t.INTERNAL=o,t.Subscription=p,t.Subscriptions=w,t.adapters=d,t.createWebSocketURL=s,t.logger=g,t.createConsumer=e,t.getConfig=n,Object.defineProperty(t,"__esModule",{value:!0})}),function(){this.Chats||(this.Chats={}),this.Chats.cable=ActionCable.createConsumer(),this.Chats.forum="",this.Chats.privt=""}.call(this),function(){var t;t=function(){function t(){this.loadChatNames(),this.initChatAutocomplete()}return t.prototype.addActive=function(t){var e,n;if(null!=t){for(e=0,n=t.length;e<n;e++)t[e].classList.remove("autocomplete-active");return this.currentFocus>=t.length&&(this.currentFocus=0),this.currentFocus<0&&(this.currentFocus=t.length-1),t[this.currentFocus].classList.add("autocomplete-active")}},t.prototype.assertText=function(t){return this.chatInput.innerHTML=this.preceeding+"<strong>@"+t+"</strong>&nbsp;",this.setCaret(),this.resetAutocomplete()},t.prototype.appendNewInput=function(t){var e;return(e=document.createElement("input")).className="to-id",Object.assign(e,{type:"hidden",value:t}),document.getElementById("chat-send").appendChild(e)},t.prototype.checkInput=function(t){var e,n,o,i,r,s;if("@"===t.originalEvent.data)this.initChatTargetList(t);else if(0<=this.atSignLoc)for(s=t.target,this.resetAutocomplete(!1),e=this.initAutocompDiv(s),o=0,i=(r=this.chatters.autocompleteList).length;o<i;o++)n=r[o],this.handleChatAutos(n,s,e)},t.prototype.collectTargetIds=function(){var t,e,n,o,i;for(i=[],e=0,n=(o=document.getElementById("chat-send").querySelectorAll("input.to-id")).length;e<n;e++)t=o[e],i.push(t.value);return i},t.prototype.createRange=function(t,e){var n,o,i;return i=t.createRange(),(n=e.body.createTextRange()).moveToElementText(this.chatInput),n.setEndPoint("EndToStart",i),(o={}).start=n.text.length,n.setEndPoint("EndToEnd",i),o.end=n.text.length,o},t.prototype.getSelectionRange=function(){var t,e,n,o;return n={start:0,end:0},"undefined"!=typeof(o=(t=this.chatInput.ownerDocument||this.chatInput.document).defaultView||t.parentWindow).getSelection?0<(e=o.getSelection()).rangeCount&&(n=this.useExistingRange(e)):(e=t.selection)&&"Control"!==e.type&&(n=this.createRange(e,t)),n},t.prototype.getPreceedingHTML=function(t){var e,n;return e=document.createTextNode("\x01"),document.getSelection().getRangeAt(0).insertNode(e),n=t.innerHTML.indexOf("\x01"),e.parentNode.removeChild(e),t.innerHTML.substr(0,n-1)},t.prototype.handleChatAutos=function(t,e,n){var o;if(o=e.textContent.substr(this.atSignLoc),t.substr(0,o.length-1).toUpperCase()===o.substr(1).toUpperCase())return n.appendChild(this.makeAutocompleteEntry(t,o))},t.prototype.handleNonInput=function(t){var e;switch(null!=(e=document.getElementById(t.target.id+"autocomplete-list"))&&(e=e.getElementsByTagName("div")),t.which){case 40:return this.currentFocus++,this.addActive(e);case 38:return this.currentFocus--,this.addActive(e);case 8:if(this.chatInput.textContent.length<=this.atSignLoc+1)return this.resetAutocomplete();break;case 13:if(t.preventDefault(),-1<this.currentFocus){if(null!=e)return e[this.currentFocus].click()}else{if(1!==$("div.autocomplete-items").size())return this.sendChat(t);if(null!=e)return e[0].click()}}},t.prototype.highlightFromUser=function(){var t,e,n,o,i,r;for(r=$("div#chat-text").attr("data-uid"),i=[],e=0,n=(o=$("div.heckles")).length;e<n;e++)t=o[e],i.push(this.tagIfMe($(t),r));return i},t.prototype.initAutocompDiv=function(t){var e,n;return(e=document.createElement("div")).id=t.id+"autocomplete-list",e.classList.add("autocomplete-items"),e.addEventListener("click",(n=this,function(t){return n.insertAndCloseAutocomplete(t.target)})),t.parentNode.appendChild(e),e},t.prototype.initChatAutocomplete=function(){var e,n;return this.chatInput=document.getElementById("chat-text"),this.resetAutocomplete(),$("#chat-text").on("keydown",(e=this,function(t){return e.handleNonInput(t)})),$("#chat-text").on("input",(n=this,function(t){return n.checkInput(t)}))},t.prototype.initChatTargetList=function(t){return this.resetAutocomplete(),this.atSignLoc=this.getSelectionRange().start-1,this.preceeding=this.getPreceedingHTML(t.target)},t.prototype.insertAndCloseAutocomplete=function(t){var e;if(t.matches("div.autocomplete-item"))return e=t.value,this.appendNewInput(this.chatters.getIdForChatter(e)),this.assertText(e)},t.prototype.insertRange=function(t){var e;return(e=window.getSelection()).removeAllRanges(),e.addRange(t)},t.prototype.locateRange=function(){var t,e;return e=document.createRange(),t=this.chatInput.lastChild,e.setStart(t,t.length),e.collapse(!0),e},t.prototype.loadChatNames=function(){return this.chatters=new ChatLookup($("#chat-text").data("chat-name-lookup"))},t.prototype.makeAutocompleteEntry=function(t,e){var n;return(n=document.createElement("div")).classList.add("autocomplete-item"),n.value=t,n.innerHTML="<strong>@"+t.substr(0,e.length-1)+"</strong>"+t.substr(e.length-1),n},t.prototype.removeAChild=function(t){t.parentNode.removeChild(t)},t.prototype.removeNodes=function(t,e){var n,o,i,r;for(o=0,i=(r=t.querySelectorAll("."+e)).length;o<i;o++)n=r[o],this.removeAChild(n)},t.prototype.resetAutocomplete=function(t){return null==t&&(t=!0),this.curChatTarget="",this.chatAutoList=[],this.currentFocus=-1,t&&(this.atSignLoc=-1),this.removeNodes(this.chatInput.parentNode,"div.autocomplete-items")},t.prototype.sendChat=function(t){var e;return""!==(e=t.target).textContent&&(Chats.forum.heckle(e.textContent,e.dataset.uid,this.collectTargetIds()),this.removeNodes(e.parentNode,"input.to-id")),e.textContent=""},t.prototype.setCaret=function(){var t;return t=this.locateRange(),this.insertRange(t),this.chatInput.focus()},t.prototype.setChatDimensions=function(){return this.setWidths(),this.setHeights()},t.prototype.setHeight=function(t,e){var n,o,i,r,s,c,u,a,h;for(o=n=0,r=(c=$(t)).length;o<r;o++)a=c[o],n+=$(a).height();for(u=[],i=0,s=e.length;i<s;i++)h=e[i],u.push($(h).css("height",n));return u},t.prototype.setHeights=function(){return this.setHeight("td.chat-header",["div#chat-header-anchor"]),this.setHeight("tr.chat-receipt",["div#chats-received"]),this.setHeight("tr.chat-sending",["div#chat-send","div#chat-text"])},t.prototype.setWidths=function(){var t,e,n,o,i,r,s,c,u,a,h,l,p;for(t=-20,n=0,r=(u=$("td.chat-width-marker")).length;n<r;n++)p=u[n],t+=$(p).width();for(o=0,s=(a=$('div[id^="chat"]')).length;o<s;o++)e=a[o],$(e).css("width",t);for(l=[],i=0,c=(h=$("div#chat-text")).length;i<c;i++)e=h[i],l.push($(e).css("width",t));return l},t.prototype.tagIfMe=function(t,e){if(t.attr("data-sid")===e)return t.addClass("from-me-in-chat")},t.prototype.useExistingRange=function(t){var e,n,o;return(e=(n=t.getRangeAt(0)).cloneRange()).selectNodeContents(this.chatInput),e.setEnd(n.startContainer,n.startOffset),(o={}).start=e.toString().length,e.setEnd(n.endContainer,n.endOffset),o.end=e.toString().length,o},t}(),$(function(){var e;return e=new t,$("#chat-text").on("input",function(t){return e.checkInput(t)}),$("#bracket").on("click",function(){return e.resetAutocomplete()}),e.setChatDimensions(),e.highlightFromUser(),document.getElementById("chat-anchor").scrollIntoView()})}.call(this),function(){this.Common=function(){function t(){}return t.reloadPage=function(){return window.location.reload()},t.showError=function(t){return alert(t)},t}()}.call(this),function(){var e,n,o,i=function(t,e){function n(){this.constructor=t}for(var o in e)r.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},r={}.hasOwnProperty;e=function(){function t(){this.chatLookups=new ChatLookup($("#chat-text").data("chat-name-lookup"))}return t.prototype.connected=function(){},t.prototype.disconnected=function(){},t.prototype.markUpHeckle=function(t){var e;return(e=$(t)).attr("data-sid")===$("div#chat-text").attr("data-uid")&&(e=e.addClass("from-me-in-chat")),e},t.prototype.received=function(t){for(;100<=$(".heckles").size();)$(".heckles").first().remove();return this.markUpHeckle(t.heckle).insertBefore($("#chat-anchor")),document.getElementById("chat-anchor").scrollIntoView()},t}(),n=function(){function t(){return t.__super__.constructor.apply(this,arguments)}return i(t,e),t.prototype.channel=function(){return{channel:"ForumChannel",room:"common_room"}},t.prototype.heckle=function(t,e,n){return this.perform("heckle",{message:t,id:e,targets:n})},t}(),o=function(){function t(){return t.__super__.constructor.apply(this,arguments)}return i(t,e),t.prototype.channel=function(){return{channel:"PrivateChannel",room:$("table.bracket").data("chat")}},t}(),$(function(){return $(document).on("turbolinks:load",function(){var t;return t=new n,Chats.forum=Chats.cable.subscriptions.create(t.channel(),t),t=new o,Chats.privt=Chats.cable.subscriptions.create(t.channel(),t)})})}.call(this);